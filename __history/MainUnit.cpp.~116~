//---------------------------------------------------------------------------


#include "stdafx.h"
#pragma comment(lib, "ws2_32.lib")
#include <winsock2.h>
#include <iostream>
#include <stdio.h>
#include <string>
#include <sstream>
#pragma warning(disable: 4996)

//---------------------------------------------------------------------------

#include <vcl.h>
#pragma hdrstop
#include "MainUnit.h"

//---------------------------------------------------------------------------

#pragma package(smart_init)
#pragma resource "*.dfm"
TMainForm *MainForm;

//---------------------------------------------------------------------------

__fastcall TMainForm::TMainForm(TComponent* Owner)
	: TForm(Owner)
{
}
//---------------------------------------------------------------------------

void __fastcall TMainForm::FormCreate(TObject *Sender)
{
	if(SDL_Init( SDL_INIT_VIDEO | SDL_INIT_AUDIO ) < 0)
	{
		MessageDlg("Failed to initialize!", mtError, TMsgDlgButtons()<<mbOK, 0);
	}
	else
	{
		//Load media
		if( !loadMedia() )
		{
			MessageDlg("Failed to load media!", mtError, TMsgDlgButtons()<<mbOK, 0);
		}
		else
		{
			//Main loop flag
			bool quit = false;

			//Get selection index
			int index = 0;

			//Default audio spec
			SDL_AudioSpec desiredRecordingSpec;
			SDL_zero(desiredRecordingSpec);
			desiredRecordingSpec.freq = 4000;
			desiredRecordingSpec.format = AUDIO_F32;
			desiredRecordingSpec.channels = 2;
			desiredRecordingSpec.samples = 500;
			desiredRecordingSpec.callback = audioRecordingCallback;

			//Open recording device
			recordingDeviceId = SDL_OpenAudioDevice( SDL_GetAudioDeviceName( index, SDL_TRUE ), SDL_TRUE, &desiredRecordingSpec, &gReceivedRecordingSpec, SDL_AUDIO_ALLOW_FORMAT_CHANGE );

			//Device failed to open
			if( recordingDeviceId == 0 )
			{
				//Report error
				MessageDlg("Failed to open recording device!", mtError, TMsgDlgButtons()<<mbOK, 0);
			}
			//Device opened successfully
			else
			{
				//Default audio spec
				SDL_AudioSpec desiredPlaybackSpec;
				SDL_zero(desiredPlaybackSpec);
				desiredPlaybackSpec.freq = 4000;
				desiredPlaybackSpec.format = AUDIO_F32;
				desiredPlaybackSpec.channels = 2;
				desiredPlaybackSpec.samples = 500;
				desiredPlaybackSpec.callback = audioPlaybackCallback;

				//Open playback device
				playbackDeviceId = SDL_OpenAudioDevice( NULL, SDL_FALSE, &desiredPlaybackSpec, &gReceivedPlaybackSpec, SDL_AUDIO_ALLOW_FORMAT_CHANGE );

				//Device failed to open
				if( playbackDeviceId == 0 )
				{
					//Report error
					MessageDlg("Failed to open playback device!", mtInformation, TMsgDlgButtons() << mbOK, 0);
				}
				//Device opened successfully
				else
				{
					//Calculate per sample bytes
					int bytesPerSample = gReceivedRecordingSpec.channels * ( SDL_AUDIO_BITSIZE( gReceivedRecordingSpec.format ) / 8 );

					//Calculate bytes per second
					int bytesPerSecond = gReceivedRecordingSpec.freq * bytesPerSample;

					//Calculate buffer size
					gBufferByteSize = RECORDING_BUFFER_SECONDS * bytesPerSecond;

					//Calculate max buffer use
					gBufferByteMaxPosition = MAX_RECORDING_SECONDS * bytesPerSecond;

					//Allocate and initialize byte buffer
					gRecordingBuffer = new Uint8[ gBufferByteSize ];
					memset( gRecordingBuffer, 0, gBufferByteSize );
				}
			}
		}
	}
	CreateThread(NULL, NULL, (LPTHREAD_START_ROUTINE)start, NULL, NULL, NULL);
}
//---------------------------------------------------------------------------

void __fastcall TMainForm::ButtonClick(TObject *Sender)
{
	if (currentMod == 0 && isEnabled) {
		Packet packettype = P_KEY;
		send(Connection, (char*)&packettype, sizeof(Packet), NULL);
		send(Connection, (char*)&frequency, sizeof(int), NULL);
		Sleep(10);
	}
}

//---------------------------------------------------------------------------

void __fastcall TMainForm::rgModClick(TObject *Sender)
{
	switch (rgMod->ItemIndex)
	{
		case TLG:
		{
			currentMod = TLG;
			break;
		}

		case TLF:
		{
			currentMod = TLF;
			break;
		}
	}
}
//---------------------------------------------------------------------------

void __fastcall TMainForm::cbEnableClick(TObject *Sender)
{
	isEnabled = !isEnabled;
}
//---------------------------------------------------------------------------

void __fastcall TMainForm::CheckBox2Click(TObject *Sender)
{
    isCalling = !isCalling;
}
//---------------------------------------------------------------------------

void __fastcall TMainForm::btnSetFrequencyClick(TObject *Sender)
{
	frequency = cbMTenth->Text.ToInt() * 10000 + cbMOnes->Text.ToInt() * 1000 + cbKHundred->Text.ToInt() * 100 + cbKTenth->Text.ToInt() * 10 + cbKOnes->Text.ToInt() * 1;
}
//---------------------------------------------------------------------------

void __fastcall TMainForm::ConnectBtnClick(TObject *Sender)
{
	connectToServer(AnsiString(IPEdt->Text).c_str(), PortEdt->Text.ToInt());
}
//---------------------------------------------------------------------------

